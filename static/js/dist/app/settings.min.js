$(document).ready(function(){function e(){api.IMAP.get().success(function(e){0==e.length?$("#lastlogindiv").hide():(0==(e=e[0]).enabled?$("#lastlogindiv").hide():$("#lastlogindiv").show(),$("#imapusername").val(e.username),$("#imaphost").val(e.host),$("#imapport").val(e.port),$("#imappassword").val(e.password),$("#use_tls").prop("checked",e.tls),$("#use_imap").prop("checked",e.enabled),$("#folder").val(e.folder),$("#restrictdomain").val(e.restrict_domain),$("#deletecampaign").prop("checked",e.delete_campaign),$("#lastlogin").val(e.last_login_friendly),$("#imapfreq").val(e.imap_freq))}).error(function(){errorFlash("Error fetching IMAP settings")})}$('[data-toggle="tooltip"]').tooltip(),$("#apiResetForm").submit(function(e){return api.reset().success(function(e){user.api_key=e.data,successFlash(e.message),$("#api_key").val(user.api_key)}).error(function(e){errorFlash(e.message)}),!1}),$("#settingsForm").submit(function(e){return $.post("/settings",$(this).serialize()).done(function(e){successFlash(e.message)}).fail(function(e){errorFlash(e.responseJSON.message)}),!1}),$("#savesettings").click(function(){var a={};return a.host=$("#imaphost").val(),a.port=$("#imapport").val(),a.username=$("#imapusername").val(),a.password=$("#imappassword").val(),a.enabled=$("#use_imap").prop("checked"),a.tls=$("#use_tls").prop("checked"),a.folder=$("#folder").val(),a.imap_freq=$("#imapfreq").val(),a.restrict_domain=$("#restrictdomain").val(),a.delete_campaign=$("#deletecampaign").prop("checked"),""==a.host?(errorFlash("No IMAP Host specified"),document.body.scrollTop=0,document.documentElement.scrollTop=0,!1):""==a.port?(errorFlash("No IMAP Port specified"),document.body.scrollTop=0,document.documentElement.scrollTop=0,!1):isNaN(a.port)||a.port<1||a.port>65535?(errorFlash("Invalid IMAP Port"),document.body.scrollTop=0,document.documentElement.scrollTop=0,!1):(""==a.imap_freq&&(a.imap_freq="60"),query("/imap/","POST",a,!0).done(function(e){1==e.success?successFlashFade("Successfully updated IMAP settings.",2):errorFlash("Unable to update IMAP settings.")}).success(function(a){e()}).fail(function(e){errorFlash(e.responseJSON.message)}).always(function(e){document.body.scrollTop=0,document.documentElement.scrollTop=0}),!1)}),$("#validateimap").click(function(){var e={};if(e.host=$("#imaphost").val(),e.port=$("#imapport").val(),e.username=$("#imapusername").val(),e.password=$("#imappassword").val(),e.tls=$("#use_tls").prop("checked"),""==e.host)return errorFlash("No IMAP Host specified"),document.body.scrollTop=0,document.documentElement.scrollTop=0,!1;if(""==e.port)return errorFlash("No IMAP Port specified"),document.body.scrollTop=0,document.documentElement.scrollTop=0,!1;if(isNaN(e.port)||e.port<1||e.port>65535)return errorFlash("Invalid IMAP Port"),document.body.scrollTop=0,document.documentElement.scrollTop=0,!1;var a=!1;$("#advancedarea").is(":visible")&&(a=!0),$("#advancedarea").hide("slow"),$("html, body").animate({scrollTop:$(document).height()},1e3);var t=$("#validateimap").html();$("#imaphost").attr("disabled",!0),$("#imapport").attr("disabled",!0),$("#imapusername").attr("disabled",!0),$("#imappassword").attr("disabled",!0),$("#use_imap").attr("disabled",!0),$("#use_tls").attr("disabled",!0),$("#validateimap").attr("disabled",!0),$("#validateimap").html("<i class='fa fa-circle-o-notch fa-spin'></i> Testing..."),query("/imap/validate","POST",e,!0).done(function(e){1==e.success?Swal.fire({title:"Success",html:"Logged into <b>"+$("#imaphost").val()+"</b>",type:"success"}):Swal.fire({title:"Failed!",html:"Unable to login to <b>"+$("#imaphost").val()+"</b>.",type:"error",showCancelButton:!0,cancelButtonText:"Close",confirmButtonText:"More Info",confirmButtonColor:"#428bca",allowOutsideClick:!1}).then(a=>{Swal.fire({title:"Error:",text:e.message})})}).fail(function(){Swal.fire({title:"Failed!",text:"An unecpected error occured.",type:"error"})}).always(function(){$("#imaphost").attr("disabled",!1),$("#imapport").attr("disabled",!1),$("#imapusername").attr("disabled",!1),$("#imappassword").attr("disabled",!1),$("#use_imap").attr("disabled",!1),$("#use_tls").attr("disabled",!1),$("#validateimap").attr("disabled",!1),$("#validateimap").html(t),1==a&&$("#advancedarea").show("slow")})}),$("#reporttab").click(function(){e()}),$("#advanced").click(function(){$("#advancedarea").toggle("slow"),$("html, body").animate({scrollTop:$(document).height()},1e3)});var a=localStorage.getItem("gophish.use_map");$("#use_map").prop("checked",JSON.parse(a)),$("#use_map").on("change",function(){localStorage.setItem("gophish.use_map",JSON.stringify(this.checked))}),e(),setInterval(function(){$("#lastlogin").is(":visible")&&1==$("#use_imap").prop("checked")&&api.IMAP.get().success(function(e){e.length>0&&$("#lastlogin").val(e[0].last_login_friendly)})},1e3)});